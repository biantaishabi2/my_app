## FormTemplateEditorLive 重构计划

**版本:** 1.0
**日期:** 2023-10-27

### 1. 引言

本文档旨在规划对 `FormTemplateEditorLive.ex` LiveView 的重构工作。主要目标是提高代码的可读性、可维护性，减少代码冗余，并优化代码结构，使其更加清晰和健壮。

### 2. 主要重构任务

#### 任务 1: 提取公共 Helper 函数

*   **目的:** 将通用的数据处理、安全转换和 UI 渲染辅助函数提取到专门的 Helper 模块中，以减少 `FormTemplateEditorLive` 的代码量，并促进代码复用。
*   **建议的模块和函数列表:**
    *   **`lib/my_app_web/helpers/form_helpers.ex`**
        *   `process_item_params/1`
        *   `normalize_params/1`
        *   `convert_type_to_atom/1`
        *   `normalize_required_field/1`
        *   `requires_options?/1`
        *   `display_selected_type/1`
        *   `safe_to_atom/1`
        *   `safe_matrix_type/1`
        *   `safe_selection_type/1`
        *   `safe_caption_position/1`
        *   `render_condition_value_input/2`
        *   `format_options_for_component/1`
    *   **`lib/my_app_web/helpers/decoration_helpers.ex`**
        *   `display_decoration_type/1`
        *   `truncate/2`
        *   `render_decoration_preview/1`
        *   `render_decoration_editor/1`
*   **进度:** [已完成]

#### 任务 2: 移除未使用的代码

*   **目的:** 清理 `FormTemplateEditorLive` 文件中不再使用或冗余的代码，保持代码库的整洁。
*   **识别出的未使用函数/导入列表:**
    *   私有函数 `process_item_params/1` 及其依赖 (`normalize_params/1`, `convert_type_to_atom/1`, `normalize_required_field/1`, 可能还有 `requires_options?/1`)
    *   私有函数 `format_options/1`
    *   导入语句 `import MyAppWeb.FormLive.Edit, only: [process_options: 2]`
*   **进度:** [已完成]

#### 任务 3: 重构 Tab 渲染逻辑 ("结构设计" 和 "条件逻辑")

*   **目的:** 消除 "结构设计" 和 "条件逻辑" 两个标签页渲染逻辑中的大量重复代码。
*   **方法概述:**
    1.  创建一个新的私有函数或函数组件（例如 `render_structure_item/1`，接收包含 `element` 和 `parent_assigns` 的 map）。
    2.  将渲染单个表单项卡片的逻辑（包括查找数据库记录、构建 `form_item` 数据、渲染通用 UI、条件渲染逻辑按钮/摘要/编辑面板等）封装到此函数/组件中。
    3.  在 `render/1` 函数的 "structure" 和 "conditions" `case` 分支中，循环调用这个新的 `render_structure_item/1`。
*   **进度:** [待办]

### 3. 补充说明

*   **`process_options/2` 函数:** `FormLive.Edit.ex` 中的 `process_options/2` 主要用于处理选项的数据库事务。由于 `FormTemplateEditorLive.ex` 直接操作模板的 `structure` 数据，且渲染时依赖预加载的 `form_items`，因此该函数在此处并未实际使用，不适合提取或保留。如果未来需要，可以再考虑将其提取到合适的 Helper 模块中。
*   **图片上传和页面管理:** `FormLive.Edit.ex` 中包含处理选项图片上传和表单页面管理的逻辑。目前 `FormTemplateEditorLive.ex` 不需要这些功能，因此本次重构不包含这些函数的提取。如果未来需要，可以再考虑将其提取到合适的 Helper 模块中。

### 4. 预期收益

完成上述重构任务后，预计 `FormTemplateEditorLive.ex` 将会：

*   代码行数显著减少。
*   逻辑更清晰，更容易理解和维护。
*   减少因代码重复引入错误的风险。
*   提高了通用辅助函数的可复用性。
