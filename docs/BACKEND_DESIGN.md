# AI聊天应用后台设计文档

## 1. 数据模型设计

**用户模型 (User)**
- id: 唯一标识符
- username: 用户名
- email: 邮箱
- password_hash: 密码哈希
- avatar: 头像URL
- created_at: 创建时间
- updated_at: 更新时间

**对话模型 (Conversation)**
- id: 唯一标识符
- user_id: 所属用户ID
- title: 对话标题
- created_at: 创建时间
- updated_at: 最后更新时间

**消息模型 (Message)**
- id: 唯一标识符
- conversation_id: 所属对话ID
- role: 角色 (user/assistant)
- content: 消息内容
- timestamp: 发送时间
- status: 状态 (sent/delivered/read)

## 2. 服务层设计

**认证服务 (AuthService)**
- 用户注册、登录、注销
- 会话管理
- 权限验证

**对话服务 (ConversationService)**
- 创建、获取、更新、删除对话
- 对话列表分页和排序
- 对话标题自动生成

**消息服务 (MessageService)**
- 消息创建和检索
- 历史消息加载
- 未读消息处理

**AI服务 (AIService)**
- 连接内部Python Agent服务
- 消息处理和响应生成
- 错误处理和重试机制

## 3. LiveView路由和事件设计

**路由设计**
- `/` - 主页
- `/chat` - 聊天主界面
- `/chat/:id` - 特定对话

**LiveView模块**
- `ChatLive.Index` - 聊天主界面视图
- `ChatLive.Conversation` - 单个对话视图
- `UserLive.Settings` - 用户设置视图

**事件处理**
- `handle_event("new_conversation", _params, socket)` - 创建新对话
- `handle_event("select_conversation", %{"id" => id}, socket)` - 选择对话
- `handle_event("send_message", %{"message" => content}, socket)` - 发送消息
- `handle_event("delete_conversation", %{"id" => id}, socket)` - 删除对话

## 4. WebSocket和LiveView通信

**LiveView自动处理的WebSocket功能**
- 状态同步和DOM更新
- 实时消息传递
- 表单提交和处理

**自定义PubSub主题**
- `chat:user:{user_id}` - 用户相关的通知
- `chat:conversation:{conversation_id}` - 单个对话的更新
- `presence:chat` - 用户在线状态

## 5. AI集成

**OpenAI API集成**
- API密钥和配置管理
- 请求格式化和响应处理
- 上下文管理和历史记忆

**模型选择**
- 不同模型支持 (GPT-3.5, GPT-4等)
- 模型参数配置界面

## 6. 存储设计

**数据库**
- PostgreSQL用于结构化数据
- Redis用于缓存和会话存储

**文件存储**
- 用户头像和附件存储
- 可使用S3或本地文件系统

## 7. 安全设计

**认证安全**
- JWT或会话认证
- 密码哈希和安全存储
- HTTPS加密

**数据安全**
- 敏感信息加密
- XSS和CSRF防护
- 速率限制防止滥用

## 8. 扩展性设计

**服务模块化**
- 微服务架构可选
- 消息队列用于异步处理

**多租户支持**
- 企业级多用户支持
- 数据隔离和权限管理

## 9. 监控和日志

**系统监控**
- 服务健康检查
- 性能指标收集

**日志管理**
- 结构化日志
- 错误跟踪和报警

## 10. 未来扩展点

- 多语言支持
- 语音转文本集成
- 文档和图像处理
- 定制化AI响应训练

---

# 实施计划与进度

## 阶段1: 基础设置与核心功能 (2周)

- [x] 项目初始化与基础环境配置
- [x] 数据库设计与迁移文件创建
- [x] 基础UI设计 (完成聊天界面布局)
- [x] Phoenix认证系统实现
  - [x] 使用Phx.Gen.Auth生成认证代码
  - [x] 会话管理
- [x] 基础LiveView对话功能
  - [x] 创建新对话事件处理 (连接数据库)
  - [x] 对话列表展示组件 (连接数据库)
  - [x] 实时消息处理 (基础保存与模拟回复)

## 阶段2: 聊天核心功能 (3周)

- [x] LiveView状态管理
  - [x] 消息列表和状态管理 (数据库加载)
  - [x] 会话选择与切换 (数据库加载)
  - [x] 历史消息加载 (数据库加载)
- [ ] LiveView高级功能
  - [ ] PubSub通知系统 (用于实时更新其他在线用户)
  - [ ] Presence用户在线状态
  - [ ] "正在输入"状态指示器

## 阶段3: UI/UX完善 (2周)

- [x] 响应式设计优化
- [x] 消息气泡与布局完善
  - [x] 用户和AI消息气泡样式区分
  - [x] 头像和用户标识显示
  - [x] 时间戳格式优化
- [x] 用户体验优化
  - [x] 侧边栏交互改进
  - [x] 底部用户信息区优化
  - [x] 提示文字美化与定位
  - [ ] 加载状态
  - [ ] 错误提示
  - [ ] 动画效果

## 阶段4: AI集成与高级功能 (3周)

- [ ] AI集成
  - [ ] 连接内部Python Agent服务
  - [ ] 基本聊天功能
  - [ ] 错误处理机制
- [ ] 消息类型拓展
  - [ ] 图片支持
  - [ ] 文件分享
  - [ ] 代码块格式化
- [ ] AI功能增强 (可选, 视Agent能力)
  - [ ] 上下文感知能力
  - [ ] 多轮对话优化
  - [ ] 模型参数调整界面 (如果Agent支持)

## 阶段5: 安全与性能优化 (2周)

- [ ] 安全加固
  - [ ] API安全审查
  - [ ] 输入验证完善
  - [ ] 权限系统细化
- [ ] 性能优化
  - [ ] 数据库查询优化
  - [ ] 前端性能调优
  - [ ] 缓存策略实施

## 阶段6: 测试与部署 (2周)

- [ ] 单元测试编写
- [ ] 集成测试
- [ ] 用户验收测试
- [ ] 生产环境部署
  - [ ] 服务器配置
  - [ ] CI/CD管道设置
  - [ ] 监控系统部署

## 阶段7: 迭代与扩展 (持续)

- [ ] 用户反馈收集
- [ ] Bug修复
- [ ] 新功能迭代
- [ ] 性能持续监控与优化

## 当前进度
**进度**: 阶段1 完成, 阶段2 (约 70% 完成), 阶段3 (约 60% 完成)

**已完成的任务**:
- 基础聊天功能 (注册、登录、创建/选择对话、发送消息) 完整实现
- UI界面大幅优化，包括:
  - 消息区域布局与样式美化
  - 用户头像与AI头像样式统一
  - 侧边栏用户区域与操作按钮优化
  - 底部提示信息美化

**正在进行的任务**:
- UI/UX细节优化与修复
- 准备实现 LiveView 高级功能 (PubSub, Presence)

**下一步计划**:
- 增加错误处理与加载状态指示
- 实现 PubSub 通知系统，确保对话更新实时同步
- 实现 Presence 用户在线状态
- 实现 "正在输入" 状态指示器