<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="csrf-token" content={Phoenix.Controller.get_csrf_token()} />
  <link phx-track-static rel="stylesheet" href={~p"/assets/app.css"} />
  <script defer phx-track-static type="text/javascript" src={~p"/assets/app.js"}></script>
  <title>AI助手 - <%= @current_user.email %></title>
  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      height: 100vh !important;
      width: 100vw !important;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    .h-screen { height: 100vh !important; }
    .w-screen { width: 100vw !important; }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      background-color: #f9fafb;
    }
    .sidebar {
      width: 280px;
      background-color: #1f2937;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: all 0.3s;
      position: relative;
      padding-bottom: 15px;
      z-index: 10; /* 确保侧边栏在移动设备上显示在内容上方 */
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .top-bar {
      height: 60px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background-color: #f9fafb;
    }
    .input-container {
      padding: 16px;
      background-color: white;
      border-top: 1px solid #e5e7eb;
    }
    /* Explicit message row styling */
    .user-message-row, .ai-message-row {
      display: flex;
      width: 100%;
      margin-bottom: 1rem; /* mb-4 */
    }
    .user-message-row {
      justify-content: flex-end; /* Align user messages right */
    }
    .ai-message-row {
      justify-content: flex-start; /* Align AI messages left */
    }
    .message-wrapper {
      display: flex;
      max-width: 75%;
      align-items: flex-start; /* Align avatar and bubble at the top */
    }
    .message-wrapper.user {
      flex-direction: row-reverse; /* Avatar left, bubble right */
    }
    .message-wrapper.ai {
      flex-direction: row; /* Avatar left, bubble right */
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 10px;
      flex-shrink: 0;
    }
    .avatar.ai {
      background-color: #10b981;
      color: white;
    }
    .avatar.user {
      background-color: #6b7280;
      color: white;
    }
    .message-content {
      padding: 12px 16px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    /* 用户消息使用绿色背景，像微信那样 */
    .message-content.user-message {
      background-color: #95ec69;
      color: #000;
      border: none;
      border-top-right-radius: 4px;
    }
    /* AI消息使用白色背景 */
    .message-content.ai-message {
      background-color: white;
      color: #000;
      border: 1px solid #e5e7eb;
      border-top-left-radius: 4px;
    }
    .message-input {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      outline: none;
      resize: none;
      max-height: 120px;
      min-height: 48px;
    }
    .message-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #374151;
    }
    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    .conversation {
      padding: 10px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .conversation:hover {
      background-color: #374151;
    }
    .conversation.active {
      background-color: #4b5563;
    }
    .sidebar-footer {
      padding: 12px 10px 20px 10px; /* Increased padding, especially at bottom */
      border-top: 1px solid #374151;
      margin-bottom: 10px; /* Added margin to ensure content isn't cut off */
    }
    .send-button {
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .send-button:hover {
      background-color: #4338ca;
    }
    .input-group {
      display: flex;
      align-items: flex-end;
    }
    .hidden { display: none; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .w-full { width: 100%; }
    .font-medium { font-weight: 500; }
    .text-xl { font-size: 1.25rem; }
    .w-6 { width: 1.5rem; } /* Added for w-6 */
    .h-6 { height: 1.5rem; } /* Added for h-6 */
    .message-hint {
      text-align: center;
      margin-top: 12px;
      margin-bottom: 8px;
      padding-bottom: 8px;
      font-size: 13px;
      color: #6b7280;
      opacity: 0.8;
      font-style: italic;
      letter-spacing: 0.3px;
    }
    
    /* 移动设备适配样式 */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 85%;
        max-width: 300px;
        z-index: 20;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      /* 当侧边栏打开时，创建一个暗色遮罩覆盖主内容 */
      .sidebar-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 15;
      }
      
      .sidebar-backdrop.show {
        display: block;
      }
      
      /* 调整消息布局以更好适应小屏幕 */
      .message-wrapper {
        max-width: 85%;
      }
      
      .message-content {
        padding: 10px 12px;
        font-size: 15px;
      }
      
      /* 调整输入区域 - 修改为仅在主内容区内定位 */
      .main-content .input-container {
        padding: 8px 8px;
        position: fixed;
        bottom: 0;
        /* 修改定位方式，确保不会覆盖侧边栏 */
        left: 0;
        right: 0;
        width: 100%;
        background-color: white;
        border-top: 1px solid #e5e7eb;
        z-index: 5; /* 降低z-index，确保低于侧边栏和背景遮罩 */
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }
      
      /* 确保消息容器不被输入框遮挡 */
      .messages-container {
        padding-bottom: 170px; /* 增加底部内边距，从120px改为170px，确保最后一条消息完全可见 */
      }
      
      .message-input {
        padding: 8px;
        min-height: 36px;
        max-height: 80px;
        font-size: 16px; /* 防止iOS缩放 */
      }
      
      .send-button {
        padding: 8px;
        min-height: 36px;
      }
      
      /* 优化消息头部显示 */
      .message-header {
        font-size: 13px !important;
      }
      
      /* 提示信息缩小 */
      .message-hint {
        margin-top: 4px;
        margin-bottom: 0;
        font-size: 11px;
      }
      
      /* 键盘弹出时的样式 */
      .input-container.keyboard-active {
        position: fixed !important;
        bottom: 0 !important;
        transition: none !important;
      }
      
      /* 确保最后一条消息和最后一个消息行有足够的底部间距 */
      .ai-message-row:last-child,
      .user-message-row:last-child {
        margin-bottom: 40px !important; /* 为最后一条消息增加更多的底部间距，从20px改为40px */
      }
      
      /* 防止iOS Safari的弹性滚动影响布局 */
      body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      html {
        overflow: hidden;
        height: 100%;
      }
    }
    
    /* 桌面端侧边栏样式 */
    @media (min-width: 769px) {
      .sidebar {
        transform: none !important; /* 桌面端不使用transform */
        position: relative; /* 恢复为默认定位 */
      }
      
      .sidebar.hidden {
        display: none;
      }
      
      .sidebar-backdrop {
        display: none !important; /* 桌面端始终不显示背景遮罩 */
      }
    }
  </style>
</head>
<body id="page-body" class="h-full m-0 p-0 overflow-hidden" phx-hook="PageHook">
  <.flash_group flash={@flash} />
  <div class="chat-container">
    <div class="flex h-full w-full">
      <!-- 侧边栏背景遮罩 - 移动设备上显示 -->
      <div id="sidebar-backdrop" class={if @show_sidebar, do: "sidebar-backdrop show", else: "sidebar-backdrop"} phx-click="toggle_sidebar"></div>
      
      <!-- 侧边栏 -->
      <div id="sidebar" class={get_sidebar_classes(@show_sidebar)}>
        <div class="sidebar-header">
          <div class="flex items-center justify-between">
            <div class="text-xl font-medium">我的对话</div>
            <button phx-click="new_conversation" class="send-button" style="padding: 8px; margin: 0; background-color: #10b981;">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
            </button>
          </div>
        </div>
        <div class="conversation-list">
          <%= for conv <- @conversations do %>
            <%# Handle the temporary :new conversation differently if needed %>
            <%= if conv.id == :new do %>
              <div class={"conversation active"}> <!-- Keep it visually selected, but non-clickable? -->
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <div class="truncate"><%= conv.title %></div>
                </div>
              </div>
            <% else %>
              <div phx-click="select_conversation" phx-value-id={conv.id}
                   class={"conversation #{if @current_conversation && conv.id == @current_conversation.id, do: "active"}"}>
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                  <div class="truncate"><%= conv.title || "(无标题)" %></div>
                </div>
              </div>
            <% end %>
          <% end %>
          <%= if @conversations == [] do %>
            <p class="text-gray-400 text-center p-4 text-sm">还没有对话，点击上方 "+" 新建一个吧！</p>
          <% end %>
        </div>
        <div class="sidebar-footer">
          <!-- 优化的布局设计 -->
          <div class="flex flex-col w-full">
            <!-- 用户信息行 - 采用左对齐头像，右边文字和操作按钮的布局 -->
            <div class="flex items-center w-full">
              <!-- 左侧头像 -->
              <div class="avatar user" style="margin-right: 10px; min-width: 36px; margin-left: 2px;">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="white">
                  <!-- Head -->
                  <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" />
                  <!-- Body -->
                  <path d="M12 14C8.13401 14 5 16.134 5 19V20H19V19C19 16.134 15.866 14 12 14Z" />
                </svg>
              </div>
              
              <!-- 右侧信息区 - 垂直排列邮箱和按钮 -->
              <div class="flex flex-col flex-grow">
                <!-- 邮箱显示 -->
                <div class="font-medium truncate" style="max-width: 200px;"><%= @current_user.email %></div>
                
                <!-- 操作按钮 - 在邮箱下方，左对齐 -->
                <div class="flex mt-2">
                  <.link href={~p"/users/settings"} class="text-gray-400 hover:text-white transition-all mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </.link>
                  
                  <!-- 修改登出链接，使用form替代link，确保包含CSRF令牌 -->
                  <form action={~p"/users/log_out"} method="post" class="inline">
                    <input type="hidden" name="_csrf_token" value={Phoenix.Controller.get_csrf_token()}>
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="text-gray-400 hover:text-white transition-all">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7" />
                      </svg>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 主内容区 -->
      <div class="main-content">
        <!-- 顶部导航栏 -->
        <div class="top-bar">
          <button phx-click="toggle_sidebar" class="p-2 mr-3 rounded-md hover:bg-gray-100">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <h2 class="text-xl font-medium truncate"><%= if @current_conversation, do: @current_conversation.title, else: "请选择或新建对话" %></h2>
        </div>

        <!-- 消息区域 -->
        <div id={"messages-container-#{@current_conversation && @current_conversation.id}"} class="messages-container">
          <%= if @current_conversation do %>
            <%= for {message, _idx} <- Enum.with_index(@messages) do %>
              <%# Use specific CSS classes for alignment and structure %>
              <div id={"message-#{message.id}"} class={if message.role == "user", do: "user-message-row", else: "ai-message-row"}>
                <div class={if message.role == "user", do: "message-wrapper user", else: "message-wrapper ai"}>
                  <div class={if message.role == "user", do: "avatar user", else: "avatar ai"}>
                    <%= if message.role == "assistant" do %>
                      <!-- Robot icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                      </svg>
                    <% else %>
                      <!-- User icon -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="white">
                        <!-- Head -->
                        <path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" />
                        <!-- Body -->
                        <path d="M12 14C8.13401 14 5 16.134 5 19V20H19V19C19 16.134 15.866 14 12 14Z" />
                      </svg>
                    <% end %>
                  </div>
                  <div class={if message.role == "user", do: "message-content user-message", else: "message-content ai-message"}>
                    <div class="message-header" style={"margin-bottom: 4px; " <> (if message.role == "user", do: "text-align: right;", else: "")}>
                      <span class="font-medium"><%= if message.role == "assistant", do: "AI助手", else: @current_user.email %></span>
                      <span style="margin-left: 8px; font-size: 12px; color: #6b7280;"><%= format_time(message.inserted_at) %></span>
                    </div>
                    <div class="message-text"><%= message.content %></div>
                  </div>
                </div>
              </div>
            <% end %>
            <%= if @messages == [] do %>
              <p class="text-gray-500 text-center mt-10">这个对话还没有消息。</p>
            <% end %>
          <% else %>
            <p class="text-gray-500 text-center mt-10">请在左侧选择一个对话或新建对话开始聊天。</p>
          <% end %>
        </div>

        <!-- 输入区域 -->
        <div class="input-container">
          <%= if @current_conversation do %>
            <form phx-submit="send_message" class="input-group">
              <textarea
                id="message-input"
                name="message"
                placeholder="输入消息..."
                class="message-input"
                phx-debounce="100"
                phx-hook="MessageInput"></textarea>
              <button type="submit" class="send-button">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                </svg>
              </button>
            </form>
            <!-- 提示信息 -->
            <div class="message-hint">
              <p>输入您的问题，AI助手将为您提供专业解答</p>
            </div>
          <% else %>
            <p class="text-gray-500 text-center">请先选择或创建对话。</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      initChat();
      setupMobileEvents();
    });
    
    // 聊天初始化函数
    function initChat() {
      // 使用正确的ID选择器找到消息容器
      const messagesContainer = document.querySelector('.messages-container');
      if (messagesContainer) {
        // 初始滚动到底部
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // 监听内容变化，保持滚动到底部
        const observer = new MutationObserver(() => {
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });
        
        observer.observe(messagesContainer, { childList: true, subtree: true });
      }
    }
    
    // 设置移动设备事件处理
    function setupMobileEvents() {
      // 检测设备类型
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      const isDesktop = !isMobile;
      
      if (isMobile) {
        // 添加触摸滑动手势支持
        let touchStartX = 0;
        const body = document.body;
        
        body.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
        }, { passive: true });
        
        body.addEventListener('touchmove', (e) => {
          if (!e.touches || !e.touches[0]) return;
          
          const touchX = e.touches[0].clientX;
          const diff = touchX - touchStartX;
          
          // 从左向右滑动，打开侧边栏
          if (diff > 50 && touchStartX < 30) {
            const event = new CustomEvent('phx:sidebar-toggle', { detail: { show: true } });
            window.dispatchEvent(event);
          }
          
          // 从右向左滑动，关闭侧边栏（当侧边栏已打开）
          if (diff < -50 && document.getElementById('sidebar').classList.contains('show')) {
            const event = new CustomEvent('phx:sidebar-toggle', { detail: { show: false } });
            window.dispatchEvent(event);
          }
        }, { passive: true });
      }
      
      // 为顶部导航栏的菜单按钮添加点击事件（适用于桌面端）
      const menuToggle = document.querySelector('.top-bar button[phx-click="toggle_sidebar"]');
      if (menuToggle && isDesktop) {
        // 确保桌面端的点击事件能够正常触发
        menuToggle.addEventListener('click', (e) => {
          // 这个事件会通过 phx-click 触发服务器端事件
          // 但为确保前端立即响应，我们也直接更新类名
          const sidebar = document.getElementById('sidebar');
          if (sidebar) {
            console.log('菜单按钮点击，当前类名：', sidebar.className);
          }
        });
      }
      
      // 监听自定义事件，然后调用服务器端toggle_sidebar
      window.addEventListener('phx:sidebar-toggle', (e) => {
        if (window.liveSocket) {
          const view = window.liveSocket.getViewByEl(document.querySelector('body'));
          if (view) {
            view.pushEvent('toggle_sidebar');
          }
        }
      });
    }
    
    // LiveView更新回调
    window.addEventListener('phx:update', () => {
      initChat();
    });
  </script>
</body>
</html>