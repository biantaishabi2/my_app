# CLAUDE.md - 操作指南

## 测试文件修改原则

**重要规则**：永远不要去修改测试文件，不到迫不得已的时候。如果确实需要修改测试文件，必须先征求用户的同意。这是因为测试文件中可能有严重的错误或特定的期望，修改它们可能会导致测试的有效性问题。

应遵循的方法是：
1. 分析测试文件以理解测试期望的行为
2. 调整业务代码以匹配测试期望，而不是反过来
3. 只有在获得明确授权后才能修改测试文件

## 调试与修复策略

1. **错误分析**：在修改代码前先彻底分析问题根源
   - 确定问题是数据流问题、业务逻辑问题还是显示问题
   - 使用日志记录关键步骤，跟踪数据流向
   - 确认参数传递、类型转换和数据检索过程

2. **分层修复顺序**：
   - 先确保数据结构和类型正确（例如atom vs string键、关联数据加载等）
   - 再修复业务流程和数据转换逻辑
   - 最后处理UI渲染和显示相关逻辑

3. **实现与测试分离**：
   - 不应在业务代码中添加专为测试环境设计的特殊逻辑
   - 避免使用`if Mix.env() == :test`这类条件语句
   - 业务代码应正确实现功能，而不是为了通过测试而添加特殊处理

## 测试驱动开发策略

1. **组件测试原则**：
   - 测试组件的行为而非实现细节
   - 避免对HTML结构或CSS类名的硬编码依赖
   - 对于表单控件，测试渲染、数据处理、验证和状态展示
   - 组件测试放在`form_components_test.exs`中

2. **页面测试原则**：
   - 关注页面级工作流和状态变化
   - 测试用户操作导致的数据处理结果
   - 编辑页面测试放在`edit_test.exs`中，不测试组件内部实现

3. **后端模型测试原则**：
   - 测试数据模型、验证规则和业务逻辑
   - 不涉及UI或展示层细节
   - 控件后端逻辑测试放在`forms_test.exs`中

4. **TDD流程**：
   - 先写测试定义预期行为
   - 实现最小代码使测试通过
   - 重构代码提高质量，保持测试通过
   - 每个表单控件都应该遵循此流程实现

## 其他注意事项

- 业务代码应该遵循代码库中的风格和约定
- 避免在业务代码中添加特定于测试的逻辑，除非这是唯一选择
- 保持代码简洁且易于理解
- 每次测试运行了以后要总结一下这次测试的进展以及剩下的问题
- 考虑通用性设计，避免只针对特定测试用例的硬编码解决方案
- 新控件开发应先实现测试，再实现功能
